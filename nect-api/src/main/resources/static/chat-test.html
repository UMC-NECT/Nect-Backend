<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chat API & File Upload í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 30px auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .connect-info { margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;}
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-connect { background: #4CAF50; }
        .btn-disconnect { background: #f44336; }
        .btn-load-more { background: #9E9E9E; width: 100%; margin-bottom: 10px; }
        .btn-load-more:hover { background: #757575; }

        #chat-container { border: 1px solid #ddd; height: 500px; overflow-y: auto; padding: 15px; background: #fafafa; border-radius: 5px; display: flex; flex-direction: column; }
        .message { margin: 5px 0; padding: 10px; background: white; border-radius: 8px; max-width: 70%; border: 1px solid #eee; position: relative; }
        .my-message { background: #dcf8c6; align-self: flex-end; border-color: #dcf8c6; }
        .other-message { align-self: flex-start; }

        .message-header { font-size: 0.8em; color: #666; margin-bottom: 5px; display: flex; gap: 10px; }
        .input-container { display: flex; gap: 10px; margin-top: 15px; align-items: center; }
        #message-input { flex: 1; }
        #send-button { background: #2196F3; }

        /* íŒŒì¼ ì—…ë¡œë“œ ìŠ¤íƒ€ì¼ */
        .file-upload-wrapper { display: flex; align-items: center; gap: 5px; margin-right: 5px; }
        .btn-file-select { background: #FF9800; }
        #file-input { display: none; } /* ì§„ì§œ inputì€ ìˆ¨ê¹€ */

        /* íŒŒì¼ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .file-attachment {
            display: flex; align-items: center; gap: 10px;
            background: #f1f1f1; padding: 8px; border-radius: 5px; margin-top: 5px; border: 1px solid #ddd;
        }
        .file-icon { font-size: 1.5em; }
        .file-info { display: flex; flex-direction: column; font-size: 0.9em; }
        .file-link { color: #2196F3; text-decoration: none; font-weight: bold; }

        /* ìƒíƒœ í‘œì‹œ */
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .connected { background: #4CAF50; color: white; }
        .disconnected { background: #ccc; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ—¨ï¸ í†µí•© API & íŒŒì¼ ì „ì†¡ í…ŒìŠ¤íŠ¸</h1>

    <div class="connect-info">
        <input type="number" id="room_id_input" placeholder="Room ID" value="1">
        <input type="number" id="user_id_input" placeholder="User ID" value="1">
        <button class="btn-connect" onclick="connect()">ì—°ê²° & ì…ì¥</button>
        <button class="btn-disconnect" onclick="disconnect()">ì¢…ë£Œ</button>
        <span id="connection-status" class="status-badge disconnected">Disconnected</span>
    </div>

    <div id="chat-container">
        <button id="btn-load-more" class="btn-load-more" onclick="loadOlderMessages()" style="display:none;">
            â¬†ï¸ ì´ì „ ë©”ì‹œì§€ ë”ë³´ê¸°
        </button>
        <div id="message-area"></div>
    </div>

    <div class="input-container">
        <div class="file-upload-wrapper">
            <input type="file" id="file-input" onchange="uploadFile()">
            <button class="btn-file-select" onclick="document.getElementById('file-input').click()" disabled id="btn-file">
                ğŸ“ íŒŒì¼ì²¨ë¶€
            </button>
        </div>

        <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." disabled onkeypress="if(event.key==='Enter') sendTextMessage()">
        <button id="send-button" onclick="sendTextMessage()" disabled>ì „ì†¡</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    let stompClient = null;
    let room_id = 1;
    let user_id = 1;
    let oldestMessageId = null;

    // ==========================================
    // 1. WebSocket ì—°ê²° ë° ì´ˆê¸°í™”
    // ==========================================
    function connect() {
        room_id = document.getElementById('room_id_input').value;
        user_id = document.getElementById('user_id_input').value;

        const socket = new SockJS('http://localhost:8080/ws-chat');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // ë¡œê·¸ ë„ˆë¬´ ë§ì´ ëœ¨ë©´ null ì²˜ë¦¬

        stompClient.connect({}, function() {
            setConnected(true);
            console.log('âœ… WebSocket Connected');

            // êµ¬ë…: ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
            stompClient.subscribe('/topic/chatroom/' + room_id, function(msg) {
                const body = JSON.parse(msg.body);
                // ì‹¤ì‹œê°„ ë©”ì‹œì§€ëŠ” í™”ë©´ ë§¨ ì•„ë˜ì— ì¶”ê°€
                displayMessage(body, 'append');
                scrollToBottom();
            });

            // ì´ˆê¸° ë©”ì‹œì§€ ë¡œë”©
            loadInitialMessages();

        }, function(err) {
            alert('ì—°ê²° ì‹¤íŒ¨: ' + err);
        });
    }

    // ==========================================
    // 2. ë©”ì‹œì§€ ë¡œë”© (API)
    // ==========================================
    function loadInitialMessages() {
        const url = `http://localhost:8080/chats/rooms/${room_id}/messages?user_id=${user_id}`;
        fetch(url)
            .then(res => res.json())
            .then(data => {
                const msgArea = document.getElementById('message-area');
                msgArea.innerHTML = '';

                if (data.length > 0) {
                    oldestMessageId = data[0].message_id;
                    data.forEach(msg => displayMessage(msg, 'append'));
                    scrollToBottom();
                }
                document.getElementById('btn-load-more').style.display = 'block';
            })
            .catch(err => console.error('ì´ˆê¸° ë¡œë”© ì‹¤íŒ¨:', err));
    }

    function loadOlderMessages() {
        if (!oldestMessageId) return;
        const url = `http://localhost:8080/chats/rooms/${room_id}/messages?user_id=${user_id}&lastMessage_id=${oldestMessageId}`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.length === 0) {
                    alert("ë” ì´ìƒ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    document.getElementById('btn-load-more').style.display = 'none';
                    return;
                }
                oldestMessageId = data[0].message_id;
                for (let i = data.length - 1; i >= 0; i--) {
                    displayMessage(data[i], 'prepend');
                }
            });
    }

    // ==========================================
    // 3. [í…ìŠ¤íŠ¸] ì „ì†¡ ë¡œì§
    // ==========================================
    function sendTextMessage() {
        const input = document.getElementById('message-input');
        const content = input.value.trim();
        if(content && stompClient) {
            const payload = {
                user_id: parseInt(user_id),
                content: content
            };
            // í…ìŠ¤íŠ¸ ì „ì†¡ ì—”ë“œí¬ì¸íŠ¸
            stompClient.send("/app/chat.send/" + room_id, {}, JSON.stringify(payload));
            input.value = '';
        }
    }

    // ==========================================
    // 4. [íŒŒì¼] ì—…ë¡œë“œ ë° ì „ì†¡ ë¡œì§
    // ==========================================
    function uploadFile() {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        if (!file) return;

        console.log("ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:", file.name);

        const formData = new FormData();
        formData.append("file", file);

        // 1. íŒŒì¼ ì—…ë¡œë“œ API í˜¸ì¶œ (POST /chats/files)
        fetch('http://localhost:8080/chats/files', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) throw new Error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
                return response.json();
            })
            .then(data => {
                // ì„œë²„ ì‘ë‹µ êµ¬ì¡°ê°€ data.body ì•ˆì— ì‹¤ì œ ë°ì´í„°ê°€ ìˆìœ¼ë¯€ë¡œ ì´ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤.
                const fileId = data.body ? data.body.file_id : null;

                if (fileId) {
                    console.log("âœ… ì—…ë¡œë“œ ì™„ë£Œ. File ID:", fileId);
                    sendFileSocketMessage(fileId);
                } else {
                    // ì‘ë‹µ êµ¬ì¡°ê°€ ë°”ë€Œì—ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ìƒì„¸ ë¡œê·¸ ì¶œë ¥
                    console.error("âŒ ì„œë²„ ì‘ë‹µ êµ¬ì¡°ì—ì„œ file_idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    console.log("ì‹¤ì œ ë°›ì€ ë°ì´í„°:", data);
                    alert("íŒŒì¼ ì•„ì´ë”” ì¶”ì¶œ ì‹¤íŒ¨! ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
                }

                fileInput.value = '';
            })
            .catch(error => {
                console.error("ì—…ë¡œë“œ ì—ëŸ¬:", error);
                alert("íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    function sendFileSocketMessage(fileId) {
        if(!stompClient) return;

        // [ì£¼ì˜] ì„œë²„ì˜ ChatFileSendRequestDTO í•„ë“œëª…ì´
        // camelCase(fileId)ë¼ë©´ ì•„ë˜ë¥¼ { fileId: fileId }ë¡œ ìˆ˜ì •í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
        const payload = {
            user_id: parseInt(user_id),
            file_id: parseInt(fileId)
        };

        stompClient.send("/app/chat.file/" + room_id, {}, JSON.stringify(payload));
        console.log("ğŸ“¨ íŒŒì¼ ì†Œì¼“ ì „ì†¡ ì™„ë£Œ (ID: " + fileId + ")");
    }
    // ==========================================
    // 5. í™”ë©´ ë Œë”ë§ (í…ìŠ¤íŠ¸ vs íŒŒì¼ ë¶„ê¸°)
    // ==========================================
    function displayMessage(msg, mode) {
        const area = document.getElementById('message-area');
        const div = document.createElement('div');

        const isMe = (msg.user_id == user_id);
        div.className = `message ${isMe ? 'my-message' : 'other-message'}`;

        const time = msg.created_at ? new Date(msg.created_at).toLocaleTimeString() : 'ë°©ê¸ˆ';
        const sender = msg.user_name || 'User ' + msg.user_id;

        // â˜… ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¥¸ ë‚´ìš© ìƒì„±
        let contentHtml = '';

        if (msg.message_type === 'FILE' && msg.file_info) {
            // [íŒŒì¼ ë©”ì‹œì§€]
            const file = msg.file_info;
            // ë¡œì»¬ ì„œë²„ URLì¸ ê²½ìš° localhost ë¶™ì—¬ì£¼ê¸° (í…ŒìŠ¤íŠ¸ìš©)
            const downloadUrl = file.file_url.startsWith("http")
                ? file.file_url
                : `http://localhost:8080${file.file_url}`;

            contentHtml = `
                <div class="file-attachment">
                    <span class="file-icon">ğŸ“„</span>
                    <div class="file-info">
                        <a href="${downloadUrl}" target="_blank" class="file-link">${file.original_filename}</a>
                        <span style="color:#888; font-size:0.8em;">${formatBytes(file.file_size)}</span>
                    </div>
                </div>
            `;
        } else {
            // [í…ìŠ¤íŠ¸ ë©”ì‹œì§€]
            contentHtml = `<div>${msg.content}</div>`;
        }

        div.innerHTML = `
            <div class="message-header">
                <span>${sender}</span>
                <span>${time}</span>
            </div>
            ${contentHtml}
        `;

        if (mode === 'prepend') {
            area.insertBefore(div, area.firstChild);
        } else {
            area.appendChild(div);
        }
    }

    // íŒŒì¼ ì‚¬ì´ì¦ˆ í¬ë§·íŒ… í—¬í¼
    function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }

    function disconnect() {
        if(stompClient) stompClient.disconnect();
        setConnected(false);
    }

    function setConnected(connected) {
        const badge = document.getElementById('connection-status');
        const inputs = [
            document.getElementById('message-input'),
            document.getElementById('send-button'),
            document.getElementById('btn-file') // íŒŒì¼ ë²„íŠ¼ë„ ì œì–´
        ];

        if (connected) {
            badge.innerText = "Connected";
            badge.className = "status-badge connected";
            inputs.forEach(el => el.disabled = false);
        } else {
            badge.innerText = "Disconnected";
            badge.className = "status-badge disconnected";
            inputs.forEach(el => el.disabled = true);
        }
    }

    function scrollToBottom() {
        const container = document.getElementById('chat-container');
        container.scrollTop = container.scrollHeight;
    }
</script>

</body>
</html>